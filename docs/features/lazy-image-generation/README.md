# 画像遅延生成機能

**ステータス**: ✅ **本番稼働中** (2025-09-22デプロイ完了)

## 概要
画像アップロード時に全サイズを即座に生成するのではなく、初回アクセス時にオンデマンドでリサイズ画像を生成する機能。これによりアップロード時のレスポンス向上とサーバー負荷軽減を実現する。

## 背景・課題
- **現状**: アップロード時に4サイズ（thumbnail, small, medium, large）を同期的に生成
- **問題点**:
  - アップロード時のレスポンスが遅い（体感3-5秒）
  - CPU負荷が一時的に高くなる
  - 使われないサイズも事前生成するため無駄なストレージ使用
  - 同時アップロード時のサーバー負荷が高い

## 目的
1. **UX改善**: アップロード即座にレスポンスを返す（体感速度の大幅向上）
2. **リソース最適化**: 必要なサイズのみ生成してストレージ節約
3. **負荷分散**: CPU負荷を時間的に分散化
4. **スケーラビリティ**: より多くの同時接続に対応可能に

## 機能仕様

### 基本動作フロー
1. **アップロード時**:
   - オリジナル画像のみ保存
   - サムネイル（thumbnail）のみ即座に生成
   - 他サイズは生成せずレスポンスを返す

2. **画像リクエスト時**:
   - 要求されたサイズの画像が存在するかチェック
   - 存在しない場合はその場で生成して保存
   - 生成した画像を返す
   - 次回以降は生成済み画像を直接返す

### エンドポイント設計
```
GET /api/images/{type}/{id}/{size}
```
- `type`: "reviews" または "shops"
- `id`: レビューIDまたは店舗ID
- `size`: "thumbnail", "small", "medium", "large"

### 実装方式の選択
開発環境とデプロイの容易性を考慮し、**Laravel内部での処理方式**を採用:

#### 採用案: Laravel内部処理
- APIエンドポイント経由で画像を提供
- Laravel内で「存在しなければ生成」ロジックを実装
- ローカル開発環境でも本番環境でも同じ動作

#### 非採用案: nginx try_files方式
- nginx設定の複雑化
- ローカル開発環境での動作確認が困難
- 本番環境でのみ有効

## 技術仕様

### データベース変更
画像テーブルに生成状態を管理するカラムを追加:

```sql
ALTER TABLE review_images ADD COLUMN sizes_generated JSON DEFAULT '{"thumbnail": false, "small": false, "medium": false, "large": false}';
ALTER TABLE shop_images ADD COLUMN sizes_generated JSON DEFAULT '{"thumbnail": false, "small": false, "medium": false, "large": false}';
```

### キャッシュ戦略
- 生成済み画像は1年間のブラウザキャッシュ
- `Cache-Control: public, max-age=31536000`

### エラーハンドリング
- 元画像が存在しない: 404エラー
- 生成に失敗: 500エラーとフォールバック処理
- メモリ不足: 段階的な品質低下で再試行

## パフォーマンス改善見込み

### Before（現状）
- アップロード時間: 3-5秒
- 同時アップロード可能数: 5-10件
- ストレージ使用量: 画像1枚あたり約2MB（4サイズ合計）
- largeサイズ（1200x900）を含む4サイズ生成

### After（改善後）
- アップロード時間: 0.5-1秒（80%削減）
- 同時アップロード可能数: 20-30件
- ストレージ使用量: 実使用サイズのみ（平均60%削減見込み）
- largeサイズ廃止、オリジナル画像配信で最高画質提供

## 実装結果

### 実績
- **開発期間**: 2025-09-19〜2025-09-22（4日間）
- **本番デプロイ**: 2025-09-22 17:00-18:00 JST
- **実装工数**: 約10時間（見積り8時間に対して125%）
  - 基本実装: 5時間
  - テスト作成: 2時間
  - 本番デプロイ・トラブルシューティング: 3時間

### 達成した改善
- **アップロード時間**: 3-5秒 → 0.5-1秒（**80%削減**）
- **処理速度**: largeサイズ生成削除により**約60%高速化**
- **ストレージ**: オンデマンド生成により使用量削減
- **同時処理**: より多くの同時アップロードに対応可能

## リスクと対策

### リスク
1. **初回アクセス時の遅延**
   - 対策: サムネイルは事前生成で即表示可能に

2. **同時生成による負荷**
   - 対策: ファイルロック機構で重複生成を防止

3. **ストレージI/Oボトルネック**
   - 対策: 生成中フラグで多重実行を防ぐ

## 将来的な拡張
1. **Redis Queue導入時**: 非同期ジョブとして画像生成
2. **CDN導入時**: エッジでの動的リサイズ
3. **WebP対応**: より効率的な画像フォーマット

## 関連ドキュメント
- [実装計画](./01-implementation-plan.md)
- [進捗管理](./progress.md)
- [リリース計画](./release-plan.md)
- [デプロイ報告](./deployment-report.md) ← **最新**