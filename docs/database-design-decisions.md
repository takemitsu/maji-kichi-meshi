# データベース設計判断記録

このファイルでは、マジキチメシプロジェクトにおけるデータベース設計の重要な判断・変更について記録します。

## ランキング機能の設計変更 (2025年7月10-11日)

### 背景
フロントエンド開発中に、ランキング機能のデータ構造について疑問が提起されました。

### 当初の疑問点
- **単一店舗 vs 複数店舗**: ランキングに同じ店舗を複数回登録できるべきか？
- **データ整合性**: 店舗とカテゴリの関係性について
- **パフォーマンス**: 複雑なJOINによる性能問題の懸念

### 分析結果 (2025-07-10)

#### 現在の設計検証
```sql
-- 現在のランキングテーブル構造
rankings (
    id, user_id, shop_id, category_id, 
    rank_position, created_at, updated_at
)

-- ユニーク制約
UNIQUE(user_id, shop_id, category_id)
```

#### 設計判断の根拠

1. **適切な正規化**: 
   - 単一責任の原則に従った設計
   - データ重複の排除
   - 整合性制約による品質保証

2. **柔軟性確保**:
   - 同一店舗の複数カテゴリランキング対応
   - カテゴリ別ランキングの独立性
   - 将来的な機能拡張への対応

3. **パフォーマンス最適化**:
   - 適切なインデックス設計
   - 効率的なクエリパターン
   - スケーラビリティの確保

### 新アーキテクチャの評価 (2025-07-11)

#### 実装後の優位性
- **データ整合性**: 制約による自動保証
- **クエリ効率**: 最適化されたJOIN性能
- **保守性**: 明確な責任分離
- **拡張性**: 新機能追加の容易さ

#### 技術的詳細
```sql
-- 効率的なランキング取得クエリ例
SELECT r.rank_position, s.name, s.address 
FROM rankings r
JOIN shops s ON r.shop_id = s.id
WHERE r.user_id = ? AND r.category_id = ?
ORDER BY r.rank_position;
```

### 結論

現在のランキング設計は以下の理由で**最適**と判断：

1. **正規化レベル**: 適切な第3正規形
2. **制約設計**: ビジネスルールの適切な実装
3. **性能特性**: インデックス最適化による高速クエリ
4. **保守性**: 明確な責任分離と可読性

### データベース制約修正 (2025-07-11)

#### 修正内容
- **reviewsテーブル**: ユニーク制約追加 `(user_id, shop_id)`
- **画像審査**: `review_images.moderation_status`による承認フロー実装
- **論理削除**: 適切な削除処理の実装

#### 影響
- データ整合性の向上
- 重複レビュー防止
- 管理機能の強化

### 新テーブル追加 (2025-07-09〜11)

#### 画像管理システム拡張
- **shop_images**: 店舗画像管理（4サイズ自動リサイズ）
- **プロフィール画像**: usersテーブル内に9フィールド追加
- **検閲機能**: moderation_status, moderated_by, moderated_at

#### 管理者機能強化
- **admin_login_attempts**: ログイン試行記録
- **users**: role, status, 2FA関連フィールド追加
- **shops**: status, moderated_by, moderated_at追加

#### ランキング機能正規化
- **ranking_items**: ランキングアイテム管理（新規テーブル）
- **rankings**: title, description, is_public追加

## 設計原則

### 採用している設計原則
1. **正規化**: 適切なレベルでの正規化
2. **制約**: ビジネスルールのDB制約での実装
3. **インデックス**: パフォーマンスを考慮した設計
4. **拡張性**: 将来の機能追加への配慮

### 今後の設計判断基準
- **パフォーマンス**: クエリ実行時間 < 100ms
- **整合性**: 制約による自動保証
- **保守性**: 明確な責任分離
- **スケーラビリティ**: 10万レコード対応

## 参考文献
- [database-er-diagram.md](./database-er-diagram.md) - 基本的なER図
- [technical-specs.md](./technical-specs.md) - 実装済み機能詳細