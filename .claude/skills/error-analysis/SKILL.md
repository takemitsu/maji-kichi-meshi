---
name: エラー分析プロセス
description: エラー発生時の体系的な分析手順。エラー、バグ、動かない、失敗、解決しない時に使用。
---

# エラー分析プロセス

## ⚠️ エラー対応の絶対ルール

### やってはいけないこと

- ❌ エラーメッセージを見ただけで即座に修正案を出す
- ❌ 1つの修正を試してダメだったら別の修正を試す（A修正→B修正の無限ループ）
- ❌ 「おそらく〜が原因です」と推測だけで答える
- ❌ 「完璧に動作します」などの嘘をつく

### 必須手順

エラーが発生したら、以下の4ステップを**必ず順番に**実行する。

---

## ステップ1: 情報収集（必ず全て確認）

以下の情報を全て収集してから次のステップへ進む:

### 必須情報
1. **完全なエラーメッセージ**
   - スタックトレース全体
   - エラーの種類（例: TypeError, 500 Internal Server Error）

2. **再現手順**
   - どういう操作をしたらエラーが出たか
   - 再現率（毎回 or たまに）

3. **期待される動作 vs 実際の動作**
   - 本来どうなるべきか
   - 実際にはどうなったか

4. **最近の変更内容**
   - 最後に動いていたコミット
   - それ以降の変更内容

5. **関連ログ**
   - Laravel: `backend/storage/logs/laravel-YYYY-MM-DD.log` (daily形式)
   - Frontend: ブラウザコンソール
   - Bash コマンド実行結果
   - MCP Server logs (`mcp__laravel-boost__last-error`, `mcp__laravel-boost__read-log-entries`)

### 情報収集コマンド例

```bash
# Laravel エラーログ確認（最新のログファイル）
tail -n 50 $(ls -t backend/storage/logs/laravel-*.log 2>/dev/null | head -1)

# または MCP tool を使用
mcp__laravel-boost__read-log-entries --entries 50

# Git 変更履歴確認
git log --oneline -10
git diff HEAD~1

# ブラウザコンソールの確認依頼
"ブラウザのコンソール（F12）を開いて、エラーメッセージを教えてください"
```

---

## ステップ2: 仮説立案（最低20個）

情報を収集したら、**できる理由 10個** と **できない理由 10個** を列挙する。

### テンプレート

```
## 仮説リスト

### できる理由（正常系の仮説: 10個）
1. 設定ファイルが正しく読み込まれている場合
2. 依存関係が全てインストールされている場合
3. キャッシュが最新の状態である場合
4. データベース接続が正常である場合
5. 環境変数が正しく設定されている場合
6. ファイルパーミッションが適切である場合
7. ポートが空いている場合
8. 外部APIが正常に応答している場合
9. ブラウザキャッシュがクリアされている場合
10. タイムゾーン設定が正しい場合

### できない理由（異常系の仮説: 10個）
1. キャッシュが古い（Laravel: config/route/view cache）
2. .env ファイルが読み込まれていない
3. composer install / npm install が実行されていない
4. データベースマイグレーションが実行されていない
5. ファイルパーミッションエラー（storage/, bootstrap/cache/）
6. ポート競合（3000, 3002, 8000が既に使用中）
7. CORS設定が間違っている
8. JWT トークンの有効期限切れ
9. MySQL と SQLite の互換性問題（本番MySQL、テストSQLite）
10. ブラウザの LocalStorage が満杯
```

プロジェクト固有の仮説も追加する:
- **データベース**: 本番環境は MySQL、テスト環境は SQLite（互換性問題に注意）
- Intervention Image の設定
- Filament の認証設定
- Redis Rate Limiter の接続
- Nuxt と Laravel の API 通信

---

## ステップ3: 検証計画

仮説を検証する順序を決める。優先順位:

1. **影響が大きく、簡単に確認できるもの** （例: キャッシュクリア）
2. **よくあるエラー** （例: npm install忘れ）
3. **環境依存の問題** （例: ポート競合）
4. **複雑な問題** （例: コードのロジックバグ）

### 検証計画テンプレート

```
## 検証計画

### 優先度 High（すぐ確認できる）
- [ ] Laravel キャッシュクリア: `php artisan cache:clear && php artisan config:clear`
- [ ] ブラウザキャッシュクリア + ハードリロード（Cmd+Shift+R）
- [ ] .env ファイルの設定確認

### 優先度 Medium
- [ ] エラーログの詳細確認
- [ ] 関連ファイルの変更履歴確認
- [ ] データベースの状態確認（マイグレーション実行状況、接続確認）

### 優先度 Low（時間がかかる、まれなケース）
- [ ] コードのロジック見直し
- [ ] 外部API の動作確認
- [ ] npm パッケージ再インストール: `rm -rf node_modules && npm install` （極めて稀）
```

---

## ステップ4: 実施と報告

### 報告フォーマット

```
## エラー分析結果

### 収集した情報
- エラー: [エラーメッセージ]
- 再現手順: [手順]
- 最近の変更: [変更内容]

### 仮説（全20個）
[できる理由10個 + できない理由10個]

### 検証計画
[優先順位付き検証項目]

### 次のステップ提案
優先度Highの項目から確認していきます。
まず [具体的な確認内容] を実行してもよろしいでしょうか？
```

ユーザーの承認を得てから検証を開始する。

---

## 例外ケース（即座に修正してOK）

以下の場合は、このプロセスをスキップして即修正可:

1. **明らかなタイポ・構文エラー**
   - 例: `functon` → `function`、セミコロン忘れ

2. **ユーザーが即修正を明示**
   - 例: 「この行を修正して」「すぐ直して」

3. **過去に解決した同じエラー**
   - 同一セッション内で既に解決済みの問題

---

## プロジェクト固有のよくあるエラー

### Laravel関連

```
Error: Class 'Intervention\Image\Facades\Image' not found
→ config/app.php の providers 確認
→ php artisan config:clear

SQLSTATE[HY000]: General error: 1 no such column
→ MySQL と SQLite の互換性問題
→ マイグレーション確認、テーブル存在確認
```

### Nuxt関連

```
Module not found: Can't resolve '@/composables/useAuth'
→ npm install 実行
→ .nuxt/ ディレクトリ削除して npm run dev

CORS policy error
→ backend/config/cors.php の allowed_origins 確認
→ http://localhost:3002 が含まれているか
```

### 認証関連

```
401 Unauthorized
→ JWT トークンの有効期限確認
→ LocalStorage の token 確認
→ backend/.env の JWT_SECRET 確認
```

---

## まとめ

エラーが起きたら:

1. 📊 **情報収集** - ログ・エラーメッセージ・変更履歴を全て確認
2. 🧠 **仮説立案** - できる理由10個 + できない理由10個
3. 📋 **検証計画** - 優先順位をつける
4. 🔍 **実施と報告** - ユーザーと相談しながら進める

**推測で修正を繰り返さない。体系的に分析する。**
